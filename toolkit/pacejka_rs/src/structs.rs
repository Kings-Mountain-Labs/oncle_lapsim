use numpy::ndarray::ArrayView1;
use pyo3::{exceptions::PyIndexError, PyResult};
use serde::{Deserialize, Serialize};

#[derive(Default, PartialEq, Clone, Serialize, Deserialize)]
pub enum MFVersion {
    #[default]
    MF52,
    MF61,
    MF62,
}

#[derive(Default, PartialEq, Clone)]
pub enum UseMode {
    #[default]
    SteadyState,
    LinearTransience,
    Nonlinear,
}

#[derive(Default, Clone)]
pub struct Inputs {
    pub fz: f64,
    pub alpha: f64,
    pub gamma: f64,
    pub kappa: f64,
    pub p: f64,
    pub u_vcx: f64,
    pub omega: f64,
    pub phi: f64,
}

#[derive(Default, Clone)]
pub struct MFOptions {
    pub use_limits_check: bool,
    pub use_alpha_star: bool,
    pub use_turn_slip: bool,
    pub use_dynamics: UseMode,
}

#[derive(Serialize, Deserialize, Default, Clone)]
pub struct PacejkaParameters {
    pub fittyp: MFVersion,
    pub epsilon: f64,
    pub longvl: f64,
    pub vxlow: f64,
    pub unloaded_radius: f64,
    pub width: f64,
    pub aspect_ratio: f64,
    pub rim_radius: f64,
    pub inflpres: f64,
    pub nompres: f64,
    pub fnomin: f64,
    pub vertical_stiffness: f64,
    pub breff: f64,
    pub dreff: f64,
    pub freff: f64,
    pub q_re0: f64,
    pub q_v1: f64,
    pub q_v2: f64,
    pub q_fz2: f64,
    pub q_fcx: f64,
    pub q_fcy: f64,
    pub q_cam: f64,
    pub pfz1: f64,
    pub bottom_offst: f64,
    pub bottom_stiff: f64,
    pub longitudinal_stiffness: f64,
    pub lateral_stiffness: f64,
    pub q_bvx: f64,
    pub q_bvt: f64,
    pub pcfx1: f64,
    pub pcfx2: f64,
    pub pcfx3: f64,
    pub pcfy1: f64,
    pub pcfy2: f64,
    pub pcfy3: f64,
    pub pcmz1: f64,
    pub q_ra1: f64,
    pub q_ra2: f64,
    pub q_rb1: f64,
    pub q_rb2: f64,
    pub presmin: f64,
    pub presmax: f64,
    pub fzmin: f64,
    pub fzmax: f64,
    pub kpumin: f64,
    pub kpumax: f64,
    pub alpmin: f64,
    pub alpmax: f64,
    pub cammin: f64,
    pub cammax: f64,
    pub lfzo: f64,
    pub lcx: f64,
    pub lmux: f64,
    pub lex: f64,
    pub lkx: f64,
    pub lhx: f64,
    pub lvx: f64,
    pub lcy: f64,
    pub lmuy: f64,
    pub ley: f64,
    pub lky: f64,
    pub lhy: f64,
    pub lvy: f64,
    pub ltr: f64,
    pub lres: f64,
    pub lxal: f64,
    pub lyka: f64,
    pub lvyka: f64,
    pub ls: f64,
    pub lkyc: f64,
    pub lkzc: f64,
    pub lvmx: f64,
    pub lmx: f64,
    pub lmy: f64,
    pub lmp: f64,
    pub pcx1: f64,
    pub pdx1: f64,
    pub pdx2: f64,
    pub pdx3: f64,
    pub pex1: f64,
    pub pex2: f64,
    pub pex3: f64,
    pub pex4: f64,
    pub pkx1: f64,
    pub pkx2: f64,
    pub pkx3: f64,
    pub phx1: f64,
    pub phx2: f64,
    pub pvx1: f64,
    pub pvx2: f64,
    pub ppx1: f64,
    pub ppx2: f64,
    pub ppx3: f64,
    pub ppx4: f64,
    pub rbx1: f64,
    pub rbx2: f64,
    pub rbx3: f64,
    pub rcx1: f64,
    pub rex1: f64,
    pub rex2: f64,
    pub rhx1: f64,
    pub qsx1: f64,
    pub qsx2: f64,
    pub qsx3: f64,
    pub qsx4: f64,
    pub qsx5: f64,
    pub qsx6: f64,
    pub qsx7: f64,
    pub qsx8: f64,
    pub qsx9: f64,
    pub qsx10: f64,
    pub qsx11: f64,
    pub qsx12: f64,
    pub qsx13: f64,
    pub qsx14: f64,
    pub ppmx1: f64,
    pub pcy1: f64,
    pub pdy1: f64,
    pub pdy2: f64,
    pub pdy3: f64,
    pub pey1: f64,
    pub pey2: f64,
    pub pey3: f64,
    pub pey4: f64,
    pub pey5: f64,
    pub pky1: f64,
    pub pky2: f64,
    pub pky3: f64,
    pub pky4: f64,
    pub pky5: f64,
    pub pky6: f64,
    pub pky7: f64,
    pub phy1: f64,
    pub phy2: f64,
    pub pvy1: f64,
    pub pvy2: f64,
    pub pvy3: f64,
    pub pvy4: f64,
    pub ppy1: f64,
    pub ppy2: f64,
    pub ppy3: f64,
    pub ppy4: f64,
    pub ppy5: f64,
    pub rby1: f64,
    pub rby2: f64,
    pub rby3: f64,
    pub rby4: f64,
    pub rcy1: f64,
    pub rey1: f64,
    pub rey2: f64,
    pub rhy1: f64,
    pub rhy2: f64,
    pub rvy1: f64,
    pub rvy2: f64,
    pub rvy3: f64,
    pub rvy4: f64,
    pub rvy5: f64,
    pub rvy6: f64,
    pub qsy1: f64,
    pub qsy2: f64,
    pub qsy3: f64,
    pub qsy4: f64,
    pub qsy5: f64,
    pub qsy6: f64,
    pub qsy7: f64,
    pub qsy8: f64,
    pub qbz1: f64,
    pub qbz2: f64,
    pub qbz3: f64,
    pub qbz4: f64,
    pub qbz5: f64,
    pub qbz9: f64,
    pub qbz10: f64,
    pub qcz1: f64,
    pub qdz1: f64,
    pub qdz2: f64,
    pub qdz3: f64,
    pub qdz4: f64,
    pub qdz6: f64,
    pub qdz7: f64,
    pub qdz8: f64,
    pub qdz9: f64,
    pub qdz10: f64,
    pub qdz11: f64,
    pub qez1: f64,
    pub qez2: f64,
    pub qez3: f64,
    pub qez4: f64,
    pub qez5: f64,
    pub qhz1: f64,
    pub qhz2: f64,
    pub qhz3: f64,
    pub qhz4: f64,
    pub ppz1: f64,
    pub ppz2: f64,
    pub ssz1: f64,
    pub ssz2: f64,
    pub ssz3: f64,
    pub ssz4: f64,
    pub pdxp1: f64,
    pub pdxp2: f64,
    pub pdxp3: f64,
    pub pkyp1: f64,
    pub pdyp1: f64,
    pub pdyp2: f64,
    pub pdyp3: f64,
    pub pdyp4: f64,
    pub phyp1: f64,
    pub phyp2: f64,
    pub phyp3: f64,
    pub phyp4: f64,
    pub pecp1: f64,
    pub pecp2: f64,
    pub qdtp1: f64,
    pub qcrp1: f64,
    pub qcrp2: f64,
    pub qbrp1: f64,
    pub qdrp1: f64,
    pub q_fcy2: f64,
    pub q_cam1: f64,
    pub q_cam2: f64,
    pub q_cam3: f64,
    pub lmuv: f64,
}

fn get_at_index(params: &ArrayView1<'_, f64>, index: usize) -> PyResult<f64> {
    params
        .get(index)
        .cloned()
        .ok_or_else(|| PyIndexError::new_err("array index out of range"))
}

impl PacejkaParameters {
    pub fn new(
        model_version: MFVersion,
        params: ArrayView1<'_, f64>,
    ) -> PyResult<PacejkaParameters> {
        Ok(PacejkaParameters {
            fittyp: model_version,
            epsilon: 1e-6,
            longvl: get_at_index(&params, 0)?,
            vxlow: get_at_index(&params, 1)?,
            unloaded_radius: get_at_index(&params, 2)?,
            width: get_at_index(&params, 3)?,
            aspect_ratio: get_at_index(&params, 4)?,
            rim_radius: get_at_index(&params, 5)?,
            inflpres: get_at_index(&params, 6)?,
            nompres: get_at_index(&params, 7)?,
            fnomin: get_at_index(&params, 8)?,
            vertical_stiffness: get_at_index(&params, 9)?,
            breff: get_at_index(&params, 10)?,
            dreff: get_at_index(&params, 11)?,
            freff: get_at_index(&params, 12)?,
            q_re0: get_at_index(&params, 13)?,
            q_v1: get_at_index(&params, 14)?,
            q_v2: get_at_index(&params, 15)?,
            q_fz2: get_at_index(&params, 16)?,
            q_fcx: get_at_index(&params, 17)?,
            q_fcy: get_at_index(&params, 18)?,
            q_cam: get_at_index(&params, 19)?,
            pfz1: get_at_index(&params, 20)?,
            bottom_offst: get_at_index(&params, 21)?,
            bottom_stiff: get_at_index(&params, 22)?,
            longitudinal_stiffness: get_at_index(&params, 23)?,
            lateral_stiffness: get_at_index(&params, 24)?,
            q_bvx: get_at_index(&params, 25)?,
            q_bvt: get_at_index(&params, 26)?,
            pcfx1: get_at_index(&params, 27)?,
            pcfx2: get_at_index(&params, 28)?,
            pcfx3: get_at_index(&params, 29)?,
            pcfy1: get_at_index(&params, 30)?,
            pcfy2: get_at_index(&params, 31)?,
            pcfy3: get_at_index(&params, 32)?,
            pcmz1: get_at_index(&params, 33)?,
            q_ra1: get_at_index(&params, 34)?,
            q_ra2: get_at_index(&params, 35)?,
            q_rb1: get_at_index(&params, 36)?,
            q_rb2: get_at_index(&params, 37)?,
            presmin: get_at_index(&params, 38)?,
            presmax: get_at_index(&params, 39)?,
            fzmin: get_at_index(&params, 40)?,
            fzmax: get_at_index(&params, 41)?,
            kpumin: get_at_index(&params, 42)?,
            kpumax: get_at_index(&params, 43)?,
            alpmin: get_at_index(&params, 44)?,
            alpmax: get_at_index(&params, 45)?,
            cammin: get_at_index(&params, 46)?,
            cammax: get_at_index(&params, 47)?,
            lfzo: get_at_index(&params, 48)?,
            lcx: get_at_index(&params, 49)?,
            lmux: get_at_index(&params, 50)?,
            lex: get_at_index(&params, 51)?,
            lkx: get_at_index(&params, 52)?,
            lhx: get_at_index(&params, 53)?,
            lvx: get_at_index(&params, 54)?,
            lcy: get_at_index(&params, 55)?,
            lmuy: get_at_index(&params, 56)?,
            ley: get_at_index(&params, 57)?,
            lky: get_at_index(&params, 58)?,
            lhy: get_at_index(&params, 59)?,
            lvy: get_at_index(&params, 60)?,
            ltr: get_at_index(&params, 61)?,
            lres: get_at_index(&params, 62)?,
            lxal: get_at_index(&params, 63)?,
            lyka: get_at_index(&params, 64)?,
            lvyka: get_at_index(&params, 65)?,
            ls: get_at_index(&params, 66)?,
            lkyc: get_at_index(&params, 67)?,
            lkzc: get_at_index(&params, 68)?,
            lvmx: get_at_index(&params, 69)?,
            lmx: get_at_index(&params, 70)?,
            lmy: get_at_index(&params, 71)?,
            lmp: get_at_index(&params, 72)?,
            pcx1: get_at_index(&params, 73)?,
            pdx1: get_at_index(&params, 74)?,
            pdx2: get_at_index(&params, 75)?,
            pdx3: get_at_index(&params, 76)?,
            pex1: get_at_index(&params, 77)?,
            pex2: get_at_index(&params, 78)?,
            pex3: get_at_index(&params, 79)?,
            pex4: get_at_index(&params, 80)?,
            pkx1: get_at_index(&params, 81)?,
            pkx2: get_at_index(&params, 82)?,
            pkx3: get_at_index(&params, 83)?,
            phx1: get_at_index(&params, 84)?,
            phx2: get_at_index(&params, 85)?,
            pvx1: get_at_index(&params, 86)?,
            pvx2: get_at_index(&params, 87)?,
            ppx1: get_at_index(&params, 88)?,
            ppx2: get_at_index(&params, 89)?,
            ppx3: get_at_index(&params, 90)?,
            ppx4: get_at_index(&params, 91)?,
            rbx1: get_at_index(&params, 92)?,
            rbx2: get_at_index(&params, 93)?,
            rbx3: get_at_index(&params, 94)?,
            rcx1: get_at_index(&params, 95)?,
            rex1: get_at_index(&params, 96)?,
            rex2: get_at_index(&params, 97)?,
            rhx1: get_at_index(&params, 98)?,
            qsx1: get_at_index(&params, 99)?,
            qsx2: get_at_index(&params, 100)?,
            qsx3: get_at_index(&params, 101)?,
            qsx4: get_at_index(&params, 102)?,
            qsx5: get_at_index(&params, 103)?,
            qsx6: get_at_index(&params, 104)?,
            qsx7: get_at_index(&params, 105)?,
            qsx8: get_at_index(&params, 106)?,
            qsx9: get_at_index(&params, 107)?,
            qsx10: get_at_index(&params, 108)?,
            qsx11: get_at_index(&params, 109)?,
            qsx12: get_at_index(&params, 110)?,
            qsx13: get_at_index(&params, 111)?,
            qsx14: get_at_index(&params, 112)?,
            ppmx1: get_at_index(&params, 113)?,
            pcy1: get_at_index(&params, 114)?,
            pdy1: get_at_index(&params, 115)?,
            pdy2: get_at_index(&params, 116)?,
            pdy3: get_at_index(&params, 117)?,
            pey1: get_at_index(&params, 118)?,
            pey2: get_at_index(&params, 119)?,
            pey3: get_at_index(&params, 120)?,
            pey4: get_at_index(&params, 121)?,
            pey5: get_at_index(&params, 122)?,
            pky1: get_at_index(&params, 123)?,
            pky2: get_at_index(&params, 124)?,
            pky3: get_at_index(&params, 125)?,
            pky4: get_at_index(&params, 126)?,
            pky5: get_at_index(&params, 127)?,
            pky6: get_at_index(&params, 128)?,
            pky7: get_at_index(&params, 129)?,
            phy1: get_at_index(&params, 130)?,
            phy2: get_at_index(&params, 131)?,
            pvy1: get_at_index(&params, 132)?,
            pvy2: get_at_index(&params, 133)?,
            pvy3: get_at_index(&params, 134)?,
            pvy4: get_at_index(&params, 135)?,
            ppy1: get_at_index(&params, 136)?,
            ppy2: get_at_index(&params, 137)?,
            ppy3: get_at_index(&params, 138)?,
            ppy4: get_at_index(&params, 139)?,
            ppy5: get_at_index(&params, 140)?,
            rby1: get_at_index(&params, 141)?,
            rby2: get_at_index(&params, 142)?,
            rby3: get_at_index(&params, 143)?,
            rby4: get_at_index(&params, 144)?,
            rcy1: get_at_index(&params, 145)?,
            rey1: get_at_index(&params, 146)?,
            rey2: get_at_index(&params, 147)?,
            rhy1: get_at_index(&params, 148)?,
            rhy2: get_at_index(&params, 149)?,
            rvy1: get_at_index(&params, 150)?,
            rvy2: get_at_index(&params, 151)?,
            rvy3: get_at_index(&params, 152)?,
            rvy4: get_at_index(&params, 153)?,
            rvy5: get_at_index(&params, 154)?,
            rvy6: get_at_index(&params, 155)?,
            qsy1: get_at_index(&params, 156)?,
            qsy2: get_at_index(&params, 157)?,
            qsy3: get_at_index(&params, 158)?,
            qsy4: get_at_index(&params, 159)?,
            qsy5: get_at_index(&params, 160)?,
            qsy6: get_at_index(&params, 161)?,
            qsy7: get_at_index(&params, 162)?,
            qsy8: get_at_index(&params, 163)?,
            qbz1: get_at_index(&params, 164)?,
            qbz2: get_at_index(&params, 165)?,
            qbz3: get_at_index(&params, 166)?,
            qbz4: get_at_index(&params, 167)?,
            qbz5: get_at_index(&params, 168)?,
            qbz9: get_at_index(&params, 169)?,
            qbz10: get_at_index(&params, 170)?,
            qcz1: get_at_index(&params, 171)?,
            qdz1: get_at_index(&params, 172)?,
            qdz2: get_at_index(&params, 173)?,
            qdz3: get_at_index(&params, 174)?,
            qdz4: get_at_index(&params, 175)?,
            qdz6: get_at_index(&params, 176)?,
            qdz7: get_at_index(&params, 177)?,
            qdz8: get_at_index(&params, 178)?,
            qdz9: get_at_index(&params, 179)?,
            qdz10: get_at_index(&params, 180)?,
            qdz11: get_at_index(&params, 181)?,
            qez1: get_at_index(&params, 182)?,
            qez2: get_at_index(&params, 183)?,
            qez3: get_at_index(&params, 184)?,
            qez4: get_at_index(&params, 185)?,
            qez5: get_at_index(&params, 186)?,
            qhz1: get_at_index(&params, 187)?,
            qhz2: get_at_index(&params, 188)?,
            qhz3: get_at_index(&params, 189)?,
            qhz4: get_at_index(&params, 190)?,
            ppz1: get_at_index(&params, 191)?,
            ppz2: get_at_index(&params, 192)?,
            ssz1: get_at_index(&params, 193)?,
            ssz2: get_at_index(&params, 194)?,
            ssz3: get_at_index(&params, 195)?,
            ssz4: get_at_index(&params, 196)?,
            pdxp1: get_at_index(&params, 197)?,
            pdxp2: get_at_index(&params, 198)?,
            pdxp3: get_at_index(&params, 199)?,
            pkyp1: get_at_index(&params, 200)?,
            pdyp1: get_at_index(&params, 201)?,
            pdyp2: get_at_index(&params, 202)?,
            pdyp3: get_at_index(&params, 203)?,
            pdyp4: get_at_index(&params, 204)?,
            phyp1: get_at_index(&params, 205)?,
            phyp2: get_at_index(&params, 206)?,
            phyp3: get_at_index(&params, 207)?,
            phyp4: get_at_index(&params, 208)?,
            pecp1: get_at_index(&params, 209)?,
            pecp2: get_at_index(&params, 210)?,
            qdtp1: get_at_index(&params, 211)?,
            qcrp1: get_at_index(&params, 212)?,
            qcrp2: get_at_index(&params, 213)?,
            qbrp1: get_at_index(&params, 214)?,
            qdrp1: get_at_index(&params, 215)?,
            q_fcy2: get_at_index(&params, 216)?,
            q_cam1: get_at_index(&params, 217)?,
            q_cam2: get_at_index(&params, 218)?,
            q_cam3: get_at_index(&params, 219)?,
            lmuv: get_at_index(&params, 220)?,
        })
    }
}
